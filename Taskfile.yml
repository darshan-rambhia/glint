version: '3'

tasks:
  generate:
    desc: Generate templ templates
    cmds:
      - templ generate

  build:
    desc: Build the glint binary
    deps: [generate]
    cmds:
      - go build -ldflags="-s -w" -o target/glint ./cmd/glint

  dev:
    desc: Run glint with hot-reload (requires air â€” go install github.com/air-verse/air@latest)
    cmds:
      - air

  test:
    desc: Run tests with race detector, coverage tracking, and threshold enforcement
    cmds:
      - go run ./scripts/coverage

  lint:
    desc: Run golangci-lint
    cmds:
      - golangci-lint run ./...

  fmt:
    desc: Format code
    cmds:
      - gofmt -w .
      - templ fmt .

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf bin/ target/
      - find . -name '*_templ.go' -delete

  docker:build:
    desc: Build Docker image
    cmds:
      - docker build -t glint:dev .

  docker:run:
    desc: Run with Docker Compose
    cmds:
      - docker compose up -d

  swagger:
    desc: Generate Swagger/OpenAPI documentation
    cmds:
      - swag init -g cmd/glint/main.go -o docs/swagger

  bench:
    desc: Run all benchmarks and save report to target/reports/bench.txt (override time with BENCH_TIME=10s)
    vars:
      BENCH_TIME: '{{default "3s" .BENCH_TIME}}'
    cmds:
      - BENCH_TIME={{.BENCH_TIME}} go run ./scripts/bench

  fuzz:
    desc: Run all fuzz targets (templates, SMART, config, PVE, PBS) and save report to target/reports/fuzz.txt (override time with FUZZ_TIME=60s)
    vars:
      FUZZ_TIME: '{{default "30s" .FUZZ_TIME}}'
    cmds:
      - FUZZ_TIME={{.FUZZ_TIME}} go run ./scripts/fuzz

  deps:
    desc: Download and tidy dependencies
    cmds:
      - go mod tidy
